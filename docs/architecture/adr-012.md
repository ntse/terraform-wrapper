## **ADR-018: Terraform Version Resolution Strategy**

**Status:** Accepted
**Date:** 2025-10-17

### **Context**

Our orchestration wrapper manages multiple Terraform stacks, each defining its own `terraform.required_version` constraint.

We could install a fixed version of Terraform for each stack, however CI/CD runners often already have Terraform installed and developers may also have a valid system-wide Terraform binary in their PATH (maybe managed by tfenv).

If we already have a Terraform binary available then auto-installing every time adds unnecessary download overhead but there's also a possibility that the version of Terraform (e.g. if installed through ServiceNow) is ancient and not compatible with the stacks.

We need a strategy that detects version requirements from all stacks and then reuses the system-installed Terraform binary if it satisfies all constraints. If it doesn't, then we should fall back to automatic installation.
We can record the resolved version in a lock file for reproducibility.

### **Decision**

The Terraform wrapper will implement a Terraform version resolution strategy:

1. Detect version constraints:
   Each stackâ€™s `.tf` files are scanned for `terraform.required_version`.
   Missing constraints default to `>= 1.0.0`.

2. Detect system Terraform binary:
   The wrapper runs `terraform -version` to identify the installed version.

3. Evaluate compatibility:
   Using `github.com/hashicorp/go-version`, all stack constraints are combined.

   * If the system version satisfies all constraints then use it.
   * If not then install the nearest compatible version via `hc-install`.

4. **Lock and reuse:**
   The selected version (system or installed) is recorded in `.terraform-version.lock.json`:

   ```json
   {
     "version": "1.8.6",
     "used_system_binary": true,
     "detected_from": [
       "core-services/network",
       "applications/frontend"
     ]
   }
   ```

5. **Subsequent runs** reuse the locked version, ensuring reproducibility across developers and pipelines.

### **Rationale**

**Performance**:
Avoid unnecessary installations on CI runners or developer machines that already have a valid Terraform version.

**Compatibility:**
Still guarantees all stacks run on a version compatible with their declared constraints.

**Flexibility:**
Environment variables allow control:

* `TFWRAPPER_USE_SYSTEM_TERRAFORM=true` > always use system binary.
* `TFWRAPPER_FORCE_INSTALL=true` > always install detected version.
* `TFWRAPPER_DISABLE_INSTALL=true` > fail if incompatible.

### **Alternatives Considered**

| Option                                   | Pros                         | Cons                                              |
| ---------------------------------------- | ---------------------------- | ------------------------------------------------- |
| **Always install version**               | Deterministic and consistent | Slower, redundant in CI, unnecessary downloads    |
| **Always use system Terraform**          | Fast, simple                 | Breaks reproducibility and constraint enforcement |
| **Hybrid (chosen)**                      | Best of both worlds          | Slightly more complex logic                       |

### **Consequences**

Faster runs in CI/CD environments.
Developers can use their local Terraform installations safely.
The system automatically installs newer versions only when needed.
Requires system Terraform to be discoverable in PATH.
Version conflicts between stacks still cause orchestration failure (as designed).

### **Implementation Notes**

* Version detection and resolution are implemented in `internal/versioning/`.
* The resolved Terraform binary path is passed to all `tfexec.NewTerraform()` calls.
* The system version is detected using:

  ```bash
  terraform -version | head -n1 | sed 's/Terraform v//'
  ```
* Version constraints are validated with `github.com/hashicorp/go-version`.
* Installation uses `github.com/hashicorp/hc-install/releases`.

### **Example Output**

```
Detected Terraform version requirements:
- core-services/network: >=1.6.0, <1.9.0
- frontend: >=1.7.0

System Terraform v1.8.6 satisfies all constraints.
Using system binary: /usr/local/bin/terraform
Locked version: 1.8.6
```

If incompatible:

```
Detected Terraform version requirements:
- core-services/network: >=1.6.0, <1.9.0
- bootstrap: >=1.7.0

System Terraform v1.6.0 incompatible.
Installing Terraform v1.8.6 (latest compatible)...
Using installed binary: ~/.terraform-wrapper/versions/1.8.6/terraform
Locked version: 1.8.6
```